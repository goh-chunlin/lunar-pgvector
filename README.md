
## Connect to EC2 Using SSM

Start an SSM session:
<img width="1840" alt="image" src="https://github.com/user-attachments/assets/626ee9b1-6974-4a47-9201-6c4bf2a5bb5e" />

Locally:
[Installation](https://docs.aws.amazon.com/systems-manager/latest/userguide/install-plugin-macos-overview.html#install-plugin-macos-signed)

```bash
aws ssm start-session --target <SSMTestInstanceID> --profile chunlin_default --region ap-southeast-1 --document-name AWS-StartPortForwardingSessionToRemoteHost --parameters host="<RDSInstanceEndpoint>",portNumber="5432",localPortNumber="9000"
```

[Reference](https://aws.amazon.com/blogs/database/securely-connect-to-an-amazon-rds-or-amazon-ec2-database-instance-remotely-with-your-preferred-gui/)

## Install psql

```bash
sudo yum update -y

sudo yum search "postgres"

sudo yum install postgresql16
```

## Connect to RDS

From within the SSM session, use psql to connect to the database:
```bash
psql --host=<RDSInstanceEndpoint> --username=hsr_db_superuser --dbname=postgres
```

To list all tables:
```sql
\dt
```

To exit the psql command-line interface, simply type:

```sql
\q
```

This will quit the PostgreSQL session and return us to our shell or terminal.

## Install pgvector

```
CREATE EXTENSION vector;

SELECT typname FROM pg_type WHERE typname = 'vector';
```

```python
import json
import torch
import numpy as np
from transformers import AutoTokenizer, AutoModel

# Load your Hugging Face model
model_name = 'distilbert-base-uncased'  # Example model; replace with your choice
tokenizer = AutoTokenizer.from_pretrained(model_name)
model = AutoModel.from_pretrained(model_name)

# Function to generate embedding for a single text
def generate_embedding(text):
    # Tokenize the input text
    inputs = tokenizer(text, return_tensors='pt', truncation=True, padding=True)
    
    # Perform a forward pass to get embeddings
    with torch.no_grad():
        outputs = model(**inputs)
        embeddings = outputs.last_hidden_state.mean(dim=1)  # Average the token embeddings
    
    return embeddings.squeeze().numpy()  # Convert to numpy array

# Function to generate INSERT INTO statements with vectors
def generate_insert_statements(data):
    # Initialize list to store SQL statements
    insert_statements = []

    for record in data:
        # Extracting text and id from the record
        id = record.get('id')
        text = record.get('text')

        # Generate the embedding for the text
        embedding = generate_embedding(text)
        
        # Convert the embedding to a list
        embedding_list = embedding.tolist()
        
        # Create the SQL INSERT INTO statement
        sql_statement = f"""
        INSERT INTO embeddings (id, vector, text)
        VALUES ('{id}', ARRAY{embedding_list}, '{text}')
        ON CONFLICT (id) DO UPDATE
        SET vector = EXCLUDED.vector, text = EXCLUDED.text;
        """
        
        # Append the statement to the list
        insert_statements.append(sql_statement)

    return insert_statements

# Example data
data = [
    {"id": "1", "text": "This is a sample text."},
    {"id": "2", "text": "Another example text for embedding."},
    {"id": "3", "text": "Yet another piece of text."}
]

# Generate the INSERT INTO statements
insert_statements = generate_insert_statements(data)

# Print out the generated SQL statements
for statement in insert_statements:
    print(statement)

```

## Query pgvector

```sql
SELECT id, text, vector <-> '[0.04185963794589043, 0.01406409777700901, -0.07217928022146225, -0.011935991235077381, 0.1859179437160492, -0.4239254891872406, 0.2968596816062927, 0.1584368646144867, 0.15212419629096985, -0.25252199172973633, -0.12535721063613892, -0.07245399057865143, -0.15909750759601593, -0.026949042454361916, -0.38873836398124695, 0.03816378861665726, 0.029247978702187538, 0.15136519074440002, -0.04410944879055023, 0.048134732991456985, 0.34136080741882324, 0.010151654481887817, -0.029509972780942917, -0.06971370428800583, 0.4180299639701843, -0.04581858590245247, -0.06007520481944084, -0.12689369916915894, -0.4715818762779236, -0.162710040807724, -0.041589539498090744, -0.009991866536438465, -0.04769013077020645, 0.07920638471841812, -0.3398245573043823, -0.13350559771060944, 0.08946291357278824, 0.05542359501123428, -0.11319033056497574, -0.06885598599910736, 0.0403716079890728, 0.026286041364073753, 0.04568936675786972, 0.18664167821407318, 0.13853994011878967, -0.14583022892475128, -0.40652766823768616, 0.20613980293273926, -0.18785090744495392, 0.1438961923122406, -0.26531845331192017, 0.16819174587726593, 0.13860757648944855, 0.31616154313087463, 0.04292671009898186, 0.36388128995895386, 0.06550992280244827, -0.17859897017478943, 0.18011020123958588, -0.006307031959295273, 0.14458738267421722, 0.226698637008667, 0.1040530800819397, 0.04287271946668625, 0.17936518788337708, 0.24234604835510254, 0.06468956917524338, 0.113866426050663, -0.5714651346206665, 0.2784912586212158, -0.059053935110569, -0.19304566085338593, -0.10429291427135468, 0.03321371600031853, 0.11776252090930939, 0.36861124634742737, -0.25621652603149414, 0.2050946205854416, 0.15377028286457062, -0.20538754761219025, -0.09748062491416931, 0.28983157873153687, -0.20295754075050354, 0.14414410293102264, 0.14830677211284637, -0.08767195791006088, -0.17621558904647827, -0.05727679282426834, -0.2546822130680084, 0.38048985600471497, 0.12807440757751465, -0.04465944692492485, 0.034990523010492325, 0.29868757724761963, 0.45483285188674927, -0.21378764510154724, -0.17625318467617035, 0.13411256670951843, 0.15863032639026642, 0.01591096818447113, -0.020037610083818436, -0.4219784140586853, -0.020759854465723038, 0.19471625983715057, -0.21133387088775635, -0.024109821766614914, -0.2613830864429474, 0.14397843182086945, 0.11481821537017822, -0.4601859450340271, 0.22219035029411316, 0.19120106101036072, 0.09429733455181122, -0.06288684904575348, -0.12433085590600967, 0.01151120662689209, 0.29112759232521057, -0.010245474986732006, -0.060713719576597214, -0.09398404508829117, -0.3824319541454315, 0.20682311058044434, 0.28773435950279236, 0.5798095464706421, 0.15228712558746338, 0.28139007091522217, 0.057830482721328735, 0.06357729434967041, 0.10897593200206757, -0.15941528975963593, 0.03729063272476196, 0.4625065326690674, 0.33721429109573364, 0.02561427280306816, -0.01570925861597061, -0.017506396397948265, 0.09851055592298508, -0.026533707976341248, -0.4031437039375305, 0.08975227922201157, 0.0426003597676754, 0.27163273096084595, -0.3267703056335449, -0.200212761759758, 0.1766071617603302, 0.23905357718467712, 0.019951915368437767, -0.06819261610507965, 0.20143744349479675, 0.1907540112733841, 0.1823374330997467, -0.0587586835026741, -0.48385462164878845, -0.08676771819591522, -0.24395525455474854, 0.26506179571151733, 0.043209172785282135, -0.0794953852891922, 0.18633367121219635, 0.16240830719470978, 0.3570217192173004, 0.3861486315727234, -0.17212148010730743, -0.1105976551771164, -0.31516963243484497, -0.11914150416851044, -0.3005892336368561, 0.2081584632396698, -0.0057220133021473885, 0.26191940903663635, -0.38174039125442505, -0.18218210339546204, 0.343910276889801, 0.03497524559497833, -0.08211851119995117, 0.2074604332447052, 0.27258920669555664, -0.07784803211688995, 0.07785139232873917, -0.09064371883869171, -2.101468324661255, 0.22638003528118134, -0.08407921344041824, -0.20778870582580566, -0.05511755868792534, 0.017196446657180786, 0.2641299068927765, -0.4133771061897278, 0.09274144470691681, -0.06433138996362686, -0.23900942504405975, -0.23625238239765167, -0.28735995292663574, -0.08129356056451797, 0.509127140045166, -0.027357544749975204, -0.052642978727817535, -0.1431388109922409, -0.18032518029212952, -0.028077641502022743, 0.08162175863981247, 0.03770209103822708, 0.20836786925792694, 0.278874933719635, -0.21160325407981873, 0.5244597792625427, -0.14096307754516602, -0.1374053657054901, -0.12139459699392319, 0.16247150301933289, -0.3208536207675934, 0.2435082197189331, 0.2565418779850006, -0.26563358306884766, 0.12021957337856293, -0.02154417708516121, 0.14624568819999695, -0.2596845328807831, -0.18808017671108246, 0.02851117216050625, 0.0743253231048584, -0.22615376114845276, -0.027151387184858322, 0.23119628429412842, -0.14759929478168488, 0.21820762753486633, 0.12009479105472565, 0.2884311079978943, 0.5032116174697876, -0.06551828980445862, -0.020097199827432632, 0.050102222710847855, 0.46039390563964844, 0.20206427574157715, -0.10559995472431183, -0.11360381543636322, -0.038877636194229126, 0.09824030101299286, 0.003564292099326849, 0.07034657150506973, -0.12811581790447235, 0.22987127304077148, 0.11814884841442108, 0.020703116431832314, -0.24930410087108612, -0.1681360900402069, -0.13163121044635773, 0.20183023810386658, 0.3618634045124054, -0.17922358214855194, 0.01922133006155491, -0.35991859436035156, 0.0891784131526947, -0.37917739152908325, 0.14768080413341522, 0.023029137402772903, -0.12887215614318848, 0.1663139909505844, 0.06074303388595581, 0.10820870101451874, -0.09184535592794418, 0.024758052080869675, 0.39323776960372925, -0.004659854341298342, -0.4480953812599182, -0.1811363846063614, -0.0015352845657616854, -0.02091658115386963, 0.21388356387615204, -0.00799221359193325, -0.30327528715133667, -0.21919579803943634, -0.29053884744644165, -0.8132733106613159, -0.3098534047603607, -0.3405669331550598, 0.3688200116157532, -0.049963243305683136, -0.0363912358880043, -0.39315563440322876, -0.22809681296348572, 0.32457733154296875, -0.0892740786075592, 0.1734476536512375, 0.1382458508014679, -0.42492514848709106, -0.17010575532913208, -0.11176387965679169, 0.00273708114400506, -0.15878872573375702, -0.4146781861782074, 0.18606646358966827, -0.14470893144607544, -0.09235304594039917, 0.43287792801856995, 0.2272610366344452, 0.37823575735092163, -0.02593313716351986, -0.3667396008968353, -0.34666216373443604, -0.06520947068929672, -0.11637240648269653, -0.10653157532215118, 0.03523571416735649, -0.2120998203754425, 0.3849506080150604, -0.1471949815750122, -0.3495200574398041, -3.104581594467163, -0.04555049538612366, -0.21824145317077637, -0.23614248633384705, 0.0925339013338089, -0.14479747414588928, 0.1288028061389923, -0.2608834207057953, -0.05783921480178833, -0.16484138369560242, 0.020617486909031868, -0.15320545434951782, 0.20714780688285828, 0.41085368394851685, 0.07260867208242416, 0.4058608412742615, -0.06713669002056122, 0.12129940092563629, -0.23807016015052795, 0.13307729363441467, -0.10640406608581543, 0.029204538092017174, 0.21065235137939453, -0.15473239123821259, 0.22770991921424866, 0.17778338491916656, -0.4237024784088135, 0.170957550406456, -0.2104353904724121, -0.06668863445520401, 0.11639197915792465, -0.0702698603272438, -0.13196662068367004, 0.1923881322145462, -0.08728744089603424, 0.09883415699005127, -0.023257210850715637, 0.20627212524414062, 0.5469533801078796, 0.01857713982462883, -0.10491713136434555, 0.4058047831058502, -0.16208887100219727, -0.015805255621671677, 0.21912851929664612, -0.24664704501628876, 0.07258091866970062, -0.2678203880786896, 0.03354348614811897, 0.22079825401306152, -0.08303821086883545, -0.0739118680357933, 0.22314035892486572, 0.1727799028158188, -0.0638921856880188, -0.21304169297218323, 0.0965055376291275, 0.38678938150405884, 0.09514868259429932, -0.21579515933990479, 0.36765509843826294, -0.29663488268852234, 0.041704267263412476, -0.15861189365386963, -0.4241746962070465, -0.15282876789569855, -0.34403762221336365, -0.3223632872104645, -0.01532399095594883, 0.10968746989965439, -0.3623117506504059, 0.08320418745279312, -0.2590610980987549, -0.8730399012565613, -0.10876868665218353, 0.09797873347997665, -0.0970110073685646, -0.12166718393564224, 0.13641178607940674, -0.32493582367897034, -0.2805712819099426, -0.16743676364421844, 0.025453293696045876, 0.3370158076286316, 0.024014020338654518, 0.034065525978803635, -0.08290060609579086, -0.17361991107463837, -0.2529771029949188, -0.21614399552345276, 0.2522220015525818, -0.19688589870929718, 0.06593707203865051, 0.009361760690808296, 0.1572776436805725, 0.15874938666820526, 0.36770161986351013, -0.5057274103164673, 0.25723880529403687, -0.1144552007317543, 0.11570636183023453, -0.46730613708496094, 0.27296414971351624, -0.006467713508754969, -0.1080441102385521, 0.27925723791122437, -0.49783390760421753, 0.08523956686258316, 0.039834439754486084, -0.008471366949379444, -0.020301422104239464, -0.2561327815055847, 0.1508742868900299, -0.055424630641937256, -0.013951030559837818, -0.05115925148129463, -0.028912540525197983, 0.10384751856327057, 0.07158701121807098, 0.055716585367918015, 0.039033811539411545, 0.32353970408439636, -0.2065160721540451, -0.08735475689172745, -0.10056465864181519, -0.2161828577518463, -0.04049979895353317, -0.1983957290649414, -0.19690819084644318, -0.03789545223116875, -0.010445761494338512, -0.2016267478466034, 0.09614617377519608, -0.29097723960876465, -0.0763150006532669, -0.3284692168235779, -0.09485641866922379, 0.4289402961730957, 0.36554598808288574, 0.009909862652420998, 0.0994647815823555, 0.11641411483287811, -0.47735506296157837, 0.17538060247898102, -0.0849829912185669, 0.2996614873409271, -0.061497580260038376, 0.10197961330413818, 0.055532436817884445, 0.23765258491039276, -0.22176039218902588, -0.27105847001075745, 0.17397820949554443, -0.32738572359085083, 0.0608331672847271, -0.32841357588768005, 0.3040226101875305, 0.04078486189246178, -0.21909840404987335, -0.003616899251937866, -0.3648046553134918, 0.06849770247936249, -0.05796430632472038, 0.09189945459365845, -0.21747736632823944, -0.08984683454036713, 0.2182626724243164, -0.021554935723543167, -0.27314311265945435, 0.14185304939746857, 0.18024201691150665, -0.04818315431475639, 0.23404984176158905, 0.07155519723892212, 0.007898849435150623, 0.2891060709953308, 0.14739617705345154, -0.050853051245212555, 0.08669902384281158, 0.45178914070129395, 0.10507825762033463, -0.22722411155700684, 0.019187361001968384, 0.25584641098976135, 0.17979219555854797, 0.222991943359375, -0.16549088060855865, -0.20372554659843445, 0.1516612023115158, 0.15689684450626373, 0.07661312818527222, -0.08893387019634247, -0.3384299576282501, -0.2623751759529114, -0.33604955673217773, -0.26582470536231995, 0.3418191075325012, -0.13981926441192627, 0.3960668444633484, 0.08693640679121017, 0.3539838492870331, 0.20913150906562805, -0.502465546131134, 0.09428692609071732, 0.0073497057892382145, -0.19877830147743225, 0.4432428777217865, -0.13604077696800232, -0.27866843342781067, -0.08715647459030151, 0.037626445293426514, -0.5646178126335144, -0.3244328200817108, -0.3281009793281555, 0.11191244423389435, 0.027893323451280594, 0.019506150856614113, 0.1449633091688156, 0.20563450455665588, -0.23112449049949646, 0.011084651574492455, -0.07727639377117157, 0.258647620677948, 0.13464155793190002, 0.0998406857252121, -0.09678258001804352, -0.20303353667259216, -0.221327543258667, -0.3117593228816986, 0.23811021447181702, 0.20084306597709656, 0.1580297350883484, 0.259138286113739, -0.01211851928383112, 0.30452868342399597, -0.2206614762544632, -0.40545719861984253, 0.05530773475766182, 0.037025220692157745, -0.4725516438484192, -0.20461821556091309, -0.17478685081005096, -0.13188064098358154, -0.25946447253227234, -0.0107753099873662, -0.09325516223907471, 0.019461337476968765, 0.5840481519699097, -0.10389596223831177, 0.020811021327972412, 0.007495557423681021, -0.016830239444971085, -0.14428798854351044, -0.2710593044757843, -0.16049188375473022, -0.3547787666320801, -0.2439080774784088, 0.06765595823526382, -0.12435249239206314, 0.25844162702560425, 0.18886122107505798, 0.03524082154035568, 0.4032844007015228, 0.3072352409362793, -0.07334587723016739, 0.3931768536567688, 0.21627822518348694, -0.04560789465904236, 0.20442792773246765, -0.17109227180480957, -0.10977534204721451, -0.053079597651958466, -0.09487620741128922, 0.52495276927948, -0.0893627405166626, 0.010676002129912376, 0.11651847511529922, -0.21852192282676697, -0.08774453401565552, 0.033657465130090714, 0.3504995107650757, 0.3873291611671448, -0.2784157991409302, 0.05003521591424942, 0.2136470079421997, 0.13949182629585266, -0.14006099104881287, 0.01798163540661335, -0.02739408053457737, -0.3150888979434967, 0.0019966126419603825, 0.19592784345149994, -0.244001105427742, 0.08361945301294327, 0.03496984764933586, 0.14511297643184662, -0.02404387854039669, 0.11775581538677216, 0.0009120404720306396, 0.052906133234500885, -0.1555686891078949, 0.48514524102211, 0.344146192073822, -0.01435182522982359, 0.05640391260385513, 0.1864965260028839, 0.027526075020432472, -0.14214737713336945, 0.24532869458198547, 0.1498277187347412, -0.18582575023174286, 0.028748322278261185, 0.24729709327220917, 0.43437737226486206, -0.22163613140583038, -0.1886880248785019, -0.22893431782722473, -0.4678634703159332, 0.15947267413139343, 0.1105441227555275, -0.07807425409555435, -0.0834353119134903, 0.3148786723613739, 0.04794622212648392, -0.10157506167888641, 0.08135423809289932, -0.45723143219947815, -0.1502210795879364, 4.450082633411512e-05, 0.10555455833673477, 0.16861984133720398, 0.3116482198238373, -0.10739793628454208, 0.3996914029121399, -0.17815349996089935, -0.17110037803649902, 0.19339117407798767, 0.11645480245351791, -0.0010368197690695524, -0.09445555508136749, 0.2204938381910324, 0.2314329594373703, 0.2295534908771515, 0.14206483960151672, -0.1908251792192459, -0.0835316851735115, -0.20090265572071075, -0.11788568645715714, 0.13456431031227112, 0.15899069607257843, 0.2443705052137375, 0.13179102540016174, -0.04903401434421539, 0.07207359373569489, -0.12704947590827942, -0.05993928760290146, 0.45031437277793884, 0.1411314755678177, 0.07834072411060333, -0.6970403790473938, 0.06561003625392914, 0.12548330426216125, -0.20582127571105957, -0.2542354464530945, 0.14579418301582336, 0.27376702427864075, 0.2742355763912201, 0.003268855856731534, -0.11703480780124664, 0.14606861770153046, 0.13102427124977112, 0.1951380968093872, -0.20017623901367188, -0.173679918050766, 0.05691971257328987, 0.22430536150932312, -0.05186782032251358, -0.06006557494401932, -0.3312510550022125, -0.15683473646640778, 0.12971177697181702, -0.04349686950445175, -0.20881792902946472, -0.22774943709373474, 0.04924400523304939, -0.48592233657836914, -0.23803934454917908, 0.15984056890010834, 0.23181593418121338, -0.23655357956886292, 0.14613696932792664, -0.13601116836071014, 0.08805258572101593, -0.21612000465393066, 0.103396475315094, 0.12100660800933838, -0.01058660726994276, 0.5044209361076355, 0.22129368782043457, 0.18678541481494904, 0.23402945697307587, -0.26138240098953247, -0.1572098582983017, 0.006388634443283081, 0.0014428406720981002, 0.046374235302209854, 0.1077115535736084, 0.09893020242452621, -0.1333010494709015, -0.3312624990940094, 0.16375961899757385, 0.11416913568973541, -0.936332106590271, 0.041049204766750336, 0.015709495171904564, -0.006319922395050526, 0.08267033100128174, -0.07878772914409637, -0.055357348173856735, 0.12160744518041611, -0.16559579968452454, -0.058944009244441986, 0.23551492393016815, 0.18528404831886292, -0.03441750258207321, -0.1961674988269806, -0.18971467018127441, 0.4188554286956787, -0.13635054230690002, -0.16689088940620422, 0.1358487904071808, 0.060375772416591644, -0.04845314100384712, 0.017367491498589516, 0.08426336199045181, -0.16719934344291687, -0.04052947834134102, -0.013951344415545464, 0.017645787447690964, -0.21868082880973816, -0.17595131695270538, -0.0827263593673706, 0.06239361688494682, 0.14065535366535187, -1.947256326675415, -0.0320938304066658, 0.45098915696144104, -0.038051195442676544, -0.017256027087569237, -0.07528989017009735, 0.5166327953338623, 0.19184871017932892, -0.26675277948379517, -0.16862520575523376, 0.03575509041547775, -0.1919708549976349, -0.13351349532604218, -0.13699598610401154, 0.18682220578193665, 0.07293081283569336]' AS distance
FROM embeddings
ORDER BY distance
LIMIT 3;
```

## Screenshots

<img width="1840" alt="image" src="https://github.com/user-attachments/assets/e2848531-9e47-4142-82f4-4e264229cc55" />

<img width="1840" alt="image" src="https://github.com/user-attachments/assets/8123081a-7cb0-43e0-abdf-48a8f1297294" />

```bash
aws rds describe-db-engine-versions --default-only --engine postgres --profile chunlin_default --region ap-southeast-1
```
<img width="1837" alt="image" src="https://github.com/user-attachments/assets/9554ed44-21eb-4fe5-bb02-008346b20ca1" />

<img width="1840" alt="image" src="https://github.com/user-attachments/assets/6f910a95-b401-4f5d-8ce6-f5f7bf88413d" />
